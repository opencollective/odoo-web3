<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Odoo Invoices</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.294.0/lucide.min.css"
    />
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
          "Helvetica Neue", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .sidebar-enter {
        transform: translateX(100%);
      }
      .sidebar-enter-active {
        transform: translateX(0);
        transition: transform 300ms ease-out;
      }
      .sidebar-exit {
        transform: translateX(0);
      }
      .sidebar-exit-active {
        transform: translateX(100%);
        transition: transform 300ms ease-in;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Icons (SVG)
      const FileIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
      );

      const EyeIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          />
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
          />
        </svg>
      );

      const XIcon = () => (
        <svg
          className="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      );

      const ExternalLinkIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
          />
        </svg>
      );

      const LoaderIcon = () => (
        <svg
          className="animate-spin h-8 w-8 text-blue-600"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          ></circle>
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      );

      const DownloadIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
          />
        </svg>
      );

      const SettingsIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
          />
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
      );

      const IncomingIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M12 5v14m0 0l-5-5m5 5l5-5"
          />
        </svg>
      );

      const OutgoingIcon = () => (
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M12 19V5m0 0l-5 5m5-5l5 5"
          />
        </svg>
      );

      const handlePay = async (invoice, memo) => {
        if (!invoice?.bank_account_number) {
          throw new Error("This invoice does not have a bank account number.");
        }

        const storedConnection = localStorage.getItem("monerium_connection");

        if (!storedConnection) {
          throw new Error(
            "Connect to Monerium first from the Monerium page and set your payer account."
          );
        }

        let connection;
        try {
          connection = JSON.parse(storedConnection);
        } catch (err) {
          console.error("Failed to parse Monerium connection:", err);
          throw new Error(
            "Stored Monerium connection looks invalid. Please reconnect from the Monerium page."
          );
        }

        const {
          accessToken,
          environment = "sandbox",
          accountAddress,
        } = connection || {};

        if (!accessToken) {
          throw new Error(
            "Missing Monerium access token. Reconnect from the Monerium page."
          );
        }

        if (!accountAddress) {
          throw new Error(
            "Missing Monerium payer account. Set it from the Monerium page."
          );
        }

        const response = await fetch("/api/monerium/order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            amount: invoice.amount_total,
            iban: invoice.bank_account_number,
            memo,
            environment,
            accessToken,
            accountAddress,
            companyName: invoice.partner_name || "Unknown",
            firstName: "",
            lastName: "",
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          let msg = data.error || data.message || "Failed to place order";
          if (data.errors && data.errors.amount) {
            msg = `${data.errors.amount} (balance: ‚Ç¨${data.errors.balance})`;
          }
          throw new Error(msg);
        }

        return data.id
          ? `Payment order ${data.id} created`
          : "Payment order created";
      };

      function InvoiceCard({ invoice, onPreview, odooUrl, onPay }) {
        const firstLineItem =
          invoice.invoice_line_ids &&
          invoice.invoice_line_ids.length > 0 &&
          invoice.invoice_line_ids[0];

        const [expanded, setExpanded] = useState(false);
        const [memo, setMemo] = useState(
          invoice.ref || invoice.name || firstLineItem?.name || ""
        );
        const [paying, setPaying] = useState(false);
        const [payError, setPayError] = useState(null);
        const [paySuccess, setPaySuccess] = useState(null);
        const [showPayModal, setShowPayModal] = useState(false);

        useEffect(() => {
          setExpanded(false);
          setMemo(invoice.ref || firstLineItem?.name || "");
          setPayError(null);
          setPaySuccess(null);
        }, [invoice.id, invoice.ref, firstLineItem?.name]);

        const isIncoming =
          invoice.move_type === "in_invoice" ||
          invoice.move_type === "in_refund";
        const statusColor = {
          draft: "bg-gray-100 text-gray-800",
          posted: "bg-green-100 text-green-800",
          cancel: "bg-red-100 text-red-800",
        }[invoice.state];
        const paymentStateColor =
          invoice.payment_state === "paid"
            ? "bg-green-100 text-green-800"
            : null;

        const openInOdoo = (e) => {
          e.stopPropagation();
          const odooInvoiceUrl = `${odooUrl}/web#id=${invoice.id}&model=account.move&view_type=form`;
          window.open(odooInvoiceUrl, "_blank", "noopener,noreferrer");
        };

        const canPay =
          typeof onPay === "function" &&
          invoice.payment_state !== "paid" &&
          Boolean(invoice.bank_account_number);

        const handleOpenPayModal = (e) => {
          if (e) e.stopPropagation();
          if (!canPay || !onPay) return;
          setPayError(null);
          setShowPayModal(true);
        };

        const handleClosePayModal = () => {
          if (paying) return;
          setShowPayModal(false);
          setPayError(null);
        };

        const handleConfirmPay = async (e) => {
          if (e) e.stopPropagation();
          if (!canPay || !onPay) return;

          setPaying(true);
          setPayError(null);
          setPaySuccess(null);

          try {
            const message = await onPay(invoice, memo);
            setPaySuccess(message);
            setShowPayModal(false);
          } catch (err) {
            console.error("‚ùå Payment failed:", err.message || err);
            setPayError(err.message || "Failed to initiate payment");
          } finally {
            setPaying(false);
          }
        };

        return (
          <div className="bg-white border border-gray-200 rounded-lg hover:shadow transition-shadow">
            <button
              type="button"
              onClick={() => setExpanded((prev) => !prev)}
              className="w-full flex items-center justify-between px-4 py-4 text-left gap-4"
            >
              <div className="flex items-center gap-4 min-w-0 flex-1">
                <div
                  className={`p-2 rounded-lg ${
                    isIncoming
                      ? "bg-blue-100 text-blue-600"
                      : "bg-purple-100 text-purple-600"
                  }`}
                >
                  {isIncoming ? <IncomingIcon /> : <OutgoingIcon />}
                </div>
                <div className="flex flex-col gap-2 min-w-0">
                  <div className="flex items-center gap-2 flex-wrap">
                    <h3 className="font-semibold text-base text-gray-900 truncate max-w-xs md:max-w-sm">
                      {invoice.partner_name}
                    </h3>
                    {invoice.state !== "posted" && (
                      <span
                        className={`px-2 py-0.5 rounded text-xs font-medium ${statusColor}`}
                      >
                        {invoice.state}
                      </span>
                    )}
                    {paymentStateColor && (
                      <span
                        className={`px-2 py-0.5 rounded text-xs font-medium ${paymentStateColor}`}
                      >
                        Paid
                      </span>
                    )}
                  </div>
                  <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-600">
                    <span>{invoice.date || "‚Äî"}</span>
                    {invoice.name && (
                      <span className="truncate max-w-[180px]">
                        {invoice.name}
                      </span>
                    )}
                    {invoice.ref && (
                      <span className="truncate max-w-[160px]">
                        {invoice.ref}
                      </span>
                    )}
                    {firstLineItem && (
                      <span className="truncate max-w-[220px] text-gray-500">
                        {firstLineItem.name}
                      </span>
                    )}
                  </div>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <div>
                  {canPay && (
                    <div className="space-y-2">
                      {paySuccess && (
                        <div className="text-xs text-green-600 bg-green-50 border border-green-100 rounded px-3 py-2">
                          {paySuccess}
                        </div>
                      )}
                      <button
                        onClick={handleOpenPayModal}
                        className="inline-flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"
                      >
                        <span>Pay</span>
                      </button>
                    </div>
                  )}
                </div>
                <div className="flex flex-col items-end">
                  <span className="font-semibold text-lg text-gray-900">
                    ‚Ç¨{invoice.amount_total.toFixed(2)}
                  </span>
                </div>
                <div className="flex items-center space-x-1 text-blue-600">
                  <span className="text-sm">
                    {expanded ? "Hide details" : "View details"}
                  </span>
                  <svg
                    className={`w-4 h-4 transform transition-transform ${
                      expanded ? "rotate-180" : ""
                    }`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </div>
            </button>

            {expanded && (
              <div className="border-t border-gray-200 px-4 py-4 space-y-4 text-sm text-gray-700">
                <div className="flex flex-wrap gap-6">
                  <div>
                    <span className="block text-gray-500 text-xs uppercase tracking-wide">
                      Invoice Type
                    </span>
                    <span className="font-medium text-gray-900">
                      {isIncoming ? "Incoming (Vendor)" : "Outgoing (Customer)"}
                    </span>
                  </div>
                  <div>
                    <span className="block text-gray-500 text-xs uppercase tracking-wide">
                      Date
                    </span>
                    <span className="font-medium text-gray-900">
                      {invoice.date || "‚Äî"}
                    </span>
                  </div>
                  {invoice.invoice_date_due && (
                    <div>
                      <span className="block text-gray-500 text-xs uppercase tracking-wide">
                        Due Date
                      </span>
                      <span className="font-medium text-gray-900">
                        {invoice.invoice_date_due}
                      </span>
                    </div>
                  )}
                </div>

                {invoice.invoice_line_ids &&
                  invoice.invoice_line_ids.length > 0 && (
                    <div>
                      <span className="block text-gray-500 text-xs uppercase tracking-wide mb-2">
                        Line Items
                      </span>
                      <div className="space-y-1 max-h-40 overflow-y-auto pr-2">
                        {invoice.invoice_line_ids.map((line) => (
                          <div
                            key={line.id}
                            className="flex justify-between text-xs bg-gray-50 rounded px-2 py-1"
                          >
                            <span className="text-gray-700 truncate flex-1 mr-2">
                              {line.name}
                            </span>
                            <span className="font-medium text-gray-900 whitespace-nowrap">
                              ‚Ç¨{line.price_total.toFixed(2)}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                {invoice.messages && invoice.messages.length > 0 && (
                  <div>
                    <span className="block text-gray-500 text-xs uppercase tracking-wide mb-2">
                      Messages ({invoice.messages.length})
                    </span>
                    <div className="space-y-3">
                      {invoice.messages.slice(0, 3).map((message) => (
                        <div
                          key={message.id}
                          className="bg-white border border-gray-200 rounded-lg p-3 shadow-sm"
                        >
                          <div className="flex items-start justify-between mb-1">
                            <p className="text-sm font-semibold text-gray-900">
                              {Array.isArray(message.author_id)
                                ? message.author_id[1]
                                : "System"}
                            </p>
                            <p className="text-xs text-gray-500">
                              {new Date(message.date).toLocaleString()}
                            </p>
                          </div>
                          <div
                            className="text-gray-700 text-xs leading-relaxed"
                            dangerouslySetInnerHTML={{ __html: message.body }}
                          />
                        </div>
                      ))}
                      {invoice.messages.length > 3 && (
                        <p className="text-xs text-gray-500">
                          Showing first 3 messages. View more in Odoo.
                        </p>
                      )}
                    </div>
                  </div>
                )}

                <div className="flex flex-wrap gap-3 pt-2">
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      window.history.pushState(
                        {},
                        "",
                        `/invoices/${invoice.id}`
                      );
                      window.dispatchEvent(new PopStateEvent("popstate"));
                    }}
                    className="inline-flex items-center space-x-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors"
                  >
                    <span>View invoice</span>
                  </button>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      onPreview(invoice);
                    }}
                    className="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
                  >
                    <EyeIcon />
                    <span>Preview PDF</span>
                  </button>
                  {odooUrl && (
                    <button
                      onClick={(e) => {
                        openInOdoo(e);
                      }}
                      className="inline-flex items-center space-x-1 text-blue-600 hover:text-blue-700 px-3 py-2 rounded-lg transition-colors border border-blue-100"
                      title="Open in Odoo"
                    >
                      <ExternalLinkIcon />
                      <span>Open in Odoo</span>
                    </button>
                  )}
                </div>
              </div>
            )}

            {showPayModal && (
              <div
                className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 px-4"
                onClick={handleClosePayModal}
              >
                <div
                  className="relative w-full max-w-md bg-white rounded-lg shadow-xl p-6"
                  onClick={(e) => e.stopPropagation()}
                >
                  <button
                    onClick={handleClosePayModal}
                    className="absolute top-3 right-3 text-gray-400 hover:text-gray-600"
                    title="Close"
                  >
                    <XIcon />
                  </button>
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    Confirm Monerium Payment
                  </h3>

                  <div className="space-y-4 text-sm text-gray-700">
                    <div>
                      <span className="block text-gray-500 text-xs uppercase tracking-wide">
                        Partner
                      </span>
                      <span className="font-medium text-gray-900">
                        {invoice.partner_name || "‚Äî"}
                      </span>
                    </div>
                    <div>
                      <span className="block text-gray-500 text-xs uppercase tracking-wide">
                        Bank Account
                      </span>
                      <span className="font-mono text-xs text-gray-700 bg-gray-100 px-2 py-1 rounded">
                        {invoice.bank_account_number}
                      </span>
                    </div>
                    <div>
                      <span className="block text-gray-500 text-xs uppercase tracking-wide">
                        Amount
                      </span>
                      <span className="font-semibold text-lg text-gray-900">
                        ‚Ç¨{invoice.amount_total.toFixed(2)}
                      </span>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-600 mb-1">
                        Memo / Reference
                      </label>
                      <input
                        type="text"
                        value={memo}
                        onChange={(e) => setMemo(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      />
                    </div>
                    {payError && (
                      <div className="text-xs text-red-600 bg-red-50 border border-red-100 rounded px-3 py-2">
                        {payError}
                      </div>
                    )}
                  </div>

                  <div className="mt-6 flex items-center justify-end gap-3">
                    <button
                      onClick={handleClosePayModal}
                      className="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors"
                      disabled={paying}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleConfirmPay}
                      disabled={paying}
                      className="inline-flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors"
                    >
                      <span>{paying ? "Processing..." : "Pay"}</span>
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      function PDFSidebar({ invoice, onClose, odooUrl, sessionId }) {
        if (!invoice) return null;

        // Build proxy URL with session_id
        const proxyUrl = React.useMemo(() => {
          if (!sessionId) return "";
          const params = new URLSearchParams({
            url: invoice.pdf_url,
            session_id: sessionId,
          });
          return `/api/pdf/view?${params.toString()}`;
        }, [invoice.pdf_url, sessionId]);

        const openInNewTab = () => {
          window.open(invoice.pdf_url, "_blank", "noopener,noreferrer");
        };

        const openInOdoo = () => {
          // Construct Odoo web interface URL for the invoice
          const odooInvoiceUrl = `${odooUrl}/web#id=${invoice.id}&model=account.move&view_type=form`;
          window.open(odooInvoiceUrl, "_blank", "noopener,noreferrer");
        };

        return (
          <>
            <div
              className="fixed inset-0 bg-black bg-opacity-50 z-40"
              onClick={onClose}
            ></div>
            <div className="fixed right-0 top-0 h-full w-full md:w-3/4 lg:w-2/3 xl:w-1/2 bg-white shadow-2xl z-50 flex flex-col">
              <div className="flex items-center justify-between p-4 border-b bg-gray-50">
                <div>
                  <h2 className="text-xl font-bold text-gray-900">
                    {invoice.name}
                  </h2>
                  <p className="text-sm text-gray-500">
                    {invoice.partner_name || "No partner"}
                  </p>
                </div>
                <div className="flex items-center space-x-2">
                  {odooUrl && (
                    <button
                      onClick={openInOdoo}
                      className="p-2 hover:bg-purple-100 text-purple-600 rounded-lg transition-colors"
                      title="Open in Odoo"
                    >
                      <ExternalLinkIcon />
                    </button>
                  )}
                  <button
                    onClick={openInNewTab}
                    className="p-2 hover:bg-blue-100 text-blue-600 rounded-lg transition-colors"
                    title="Open in new tab"
                  >
                    <ExternalLinkIcon />
                  </button>
                  <a
                    href={invoice.pdf_url}
                    download
                    className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                    title="Download PDF"
                  >
                    <DownloadIcon />
                  </a>
                  <button
                    onClick={onClose}
                    className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    <XIcon />
                  </button>
                </div>
              </div>
              <div className="flex-1 overflow-hidden bg-gray-100">
                {sessionId && proxyUrl ? (
                  <iframe
                    src={proxyUrl}
                    className="w-full h-full border-0"
                    title={`PDF: ${invoice.name}`}
                    onError={() => {
                      console.error("Failed to load PDF");
                    }}
                  />
                ) : (
                  <div className="flex items-center justify-center h-full">
                    <div className="text-center">
                      <LoaderIcon />
                      <p className="text-gray-500 mt-4">Loading PDF...</p>
                    </div>
                  </div>
                )}
              </div>
              <div className="p-4 border-t bg-gray-50 space-y-2">
                <div className="flex justify-between items-center text-sm text-gray-600">
                  <span>
                    Amount:{" "}
                    <strong className="text-gray-900">
                      ‚Ç¨{invoice.amount_total.toFixed(2)}
                    </strong>
                  </span>
                  {invoice.payment_state === "paid" && (
                    <span className="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                      Paid
                    </span>
                  )}
                </div>
                <p className="text-xs text-gray-500">
                  If the PDF doesn't load, try opening in a new tab or
                  downloading it.
                </p>
              </div>
            </div>
          </>
        );
      }

      // Router component to handle URL-based navigation
      function Router({ children }) {
        const [currentPath, setCurrentPath] = useState(
          window.location.pathname
        );

        useEffect(() => {
          const onLocationChange = () => {
            setCurrentPath(window.location.pathname);
          };

          window.addEventListener("popstate", onLocationChange);
          return () => window.removeEventListener("popstate", onLocationChange);
        }, []);

        return children({
          currentPath,
          navigate: (path) => {
            window.history.pushState({}, "", path);
            setCurrentPath(path);
          },
        });
      }

      // Invoice Details View Component
      function InvoiceDetailsView({
        invoiceId,
        connectionSettings,
        sessionId,
        navigate,
      }) {
        const [invoice, setInvoice] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        useEffect(() => {
          const fetchInvoiceDetails = async () => {
            setLoading(true);
            setError(null);

            const params = new URLSearchParams();
            Object.entries(connectionSettings).forEach(([key, value]) => {
              if (value) params.append(key, value);
            });

            try {
              const response = await fetch(
                `/api/odoo/invoices/${invoiceId}?${params.toString()}`
              );
              const data = await response.json();

              if (!response.ok) {
                throw new Error(
                  data.error || "Failed to fetch invoice details"
                );
              }

              setInvoice(data.invoice);
            } catch (err) {
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };

          fetchInvoiceDetails();
        }, [invoiceId, connectionSettings]);

        if (loading) {
          return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
              <LoaderIcon />
            </div>
          );
        }

        if (error) {
          return (
            <div className="min-h-screen bg-gray-50 p-8">
              <div className="max-w-7xl mx-auto">
                <button
                  onClick={() => navigate("/")}
                  className="mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
                >
                  ‚Üê Back to Invoices
                </button>
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <p className="text-red-800">{error}</p>
                </div>
              </div>
            </div>
          );
        }

        if (!invoice) return null;

        const isIncoming =
          invoice.move_type === "in_invoice" ||
          invoice.move_type === "in_refund";
        const statusColor = {
          draft: "bg-gray-100 text-gray-800",
          posted: "bg-green-100 text-green-800",
          cancel: "bg-red-100 text-red-800",
        }[invoice.state];

        const paymentStateColor =
          invoice.payment_state === "paid"
            ? "bg-green-100 text-green-800"
            : null;

        return (
          <div className="min-h-screen bg-gray-50 p-8">
            <div className="max-w-7xl mx-auto">
              <button
                onClick={() => navigate("/")}
                className="mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
              >
                ‚Üê Back to Invoices
              </button>

              <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div className="flex items-start justify-between mb-6">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">
                      {invoice.name}
                    </h1>
                    <p className="text-gray-600">
                      {isIncoming ? "üì• Incoming" : "üì§ Outgoing"} Invoice
                    </p>
                  </div>
                  <div className="flex items-center space-x-3">
                    <span
                      className={`px-3 py-1 rounded-full text-sm font-medium ${statusColor}`}
                    >
                      {invoice.state}
                    </span>
                    {paymentStateColor && (
                      <span
                        className={`px-3 py-1 rounded-full text-sm font-medium ${paymentStateColor}`}
                      >
                        Paid
                      </span>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                  <div>
                    <h3 className="text-sm font-semibold text-gray-500 mb-1">
                      Partner
                    </h3>
                    <p className="text-lg text-gray-900">
                      {invoice.partner_name || "N/A"}
                    </p>
                  </div>
                  <div>
                    <h3 className="text-sm font-semibold text-gray-500 mb-1">
                      Date
                    </h3>
                    <p className="text-lg text-gray-900">
                      {invoice.invoice_date || invoice.date}
                    </p>
                  </div>
                  {invoice.invoice_date_due && (
                    <div>
                      <h3 className="text-sm font-semibold text-gray-500 mb-1">
                        Due Date
                      </h3>
                      <p className="text-lg text-gray-900">
                        {invoice.invoice_date_due}
                      </p>
                    </div>
                  )}
                  <div>
                    <h3 className="text-sm font-semibold text-gray-500 mb-1">
                      Total Amount
                    </h3>
                    <p className="text-2xl font-bold text-gray-900">
                      ‚Ç¨{invoice.amount_total.toFixed(2)}
                    </p>
                  </div>
                  <div>
                    <h3 className="text-sm font-semibold text-gray-500 mb-1">
                      Amount Due
                    </h3>
                    <p className="text-xl font-semibold text-gray-900">
                      ‚Ç¨{invoice.amount_residual.toFixed(2)}
                    </p>
                  </div>
                  {invoice.ref && (
                    <div>
                      <h3 className="text-sm font-semibold text-gray-500 mb-1">
                        Reference
                      </h3>
                      <p className="text-lg text-gray-900">{invoice.ref}</p>
                    </div>
                  )}
                </div>

                {invoice.bank_account_number && (
                  <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 className="text-sm font-semibold text-blue-900 mb-1">
                      Bank Account
                    </h3>
                    <p className="text-lg font-mono text-blue-900">
                      {invoice.bank_account_number}
                    </p>
                  </div>
                )}

                {invoice.narration && (
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-2">
                      Notes
                    </h3>
                    <p className="text-gray-700 whitespace-pre-wrap">
                      {invoice.narration}
                    </p>
                  </div>
                )}
              </div>

              {invoice.invoice_line_ids &&
                invoice.invoice_line_ids.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4">
                      üì¶ Line Items
                    </h2>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead>
                          <tr className="border-b border-gray-200">
                            <th className="text-left py-3 px-4 text-sm font-semibold text-gray-700">
                              Description
                            </th>
                            <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">
                              Quantity
                            </th>
                            <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">
                              Unit Price
                            </th>
                            <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">
                              Subtotal
                            </th>
                            <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">
                              Total
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          {invoice.invoice_line_ids.map((line) => (
                            <tr
                              key={line.id}
                              className="border-b border-gray-100"
                            >
                              <td className="py-3 px-4 text-gray-900">
                                {line.name}
                              </td>
                              <td className="text-right py-3 px-4 text-gray-900">
                                {line.quantity}
                              </td>
                              <td className="text-right py-3 px-4 text-gray-900">
                                ‚Ç¨{line.price_unit.toFixed(2)}
                              </td>
                              <td className="text-right py-3 px-4 text-gray-900">
                                ‚Ç¨{line.price_subtotal.toFixed(2)}
                              </td>
                              <td className="text-right py-3 px-4 font-semibold text-gray-900">
                                ‚Ç¨{line.price_total.toFixed(2)}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                        <tfoot>
                          <tr className="border-t-2 border-gray-300">
                            <td colSpan="3" className="py-3 px-4"></td>
                            <td className="text-right py-3 px-4 font-semibold text-gray-700">
                              Subtotal:
                            </td>
                            <td className="text-right py-3 px-4 font-semibold text-gray-900">
                              ‚Ç¨{invoice.amount_untaxed.toFixed(2)}
                            </td>
                          </tr>
                          <tr>
                            <td colSpan="3" className="py-3 px-4"></td>
                            <td className="text-right py-3 px-4 font-semibold text-gray-700">
                              Tax:
                            </td>
                            <td className="text-right py-3 px-4 font-semibold text-gray-900">
                              ‚Ç¨{invoice.amount_tax.toFixed(2)}
                            </td>
                          </tr>
                          <tr className="border-t border-gray-200">
                            <td colSpan="3" className="py-3 px-4"></td>
                            <td className="text-right py-3 px-4 text-lg font-bold text-gray-900">
                              Total:
                            </td>
                            <td className="text-right py-3 px-4 text-lg font-bold text-gray-900">
                              ‚Ç¨{invoice.amount_total.toFixed(2)}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                )}

              {invoice.attachments && invoice.attachments.length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-4">
                    üìé Attachments ({invoice.attachments.length})
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {invoice.attachments.map((attachment) => (
                      <a
                        key={attachment.id}
                        href={attachment.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                      >
                        <FileIcon />
                        <div className="ml-3 flex-1">
                          <p className="text-sm font-medium text-gray-900">
                            {attachment.name}
                          </p>
                          <p className="text-xs text-gray-500">
                            {attachment.mimetype}
                          </p>
                          {attachment.file_size && (
                            <p className="text-xs text-gray-500">
                              {(attachment.file_size / 1024).toFixed(2)} KB
                            </p>
                          )}
                        </div>
                      </a>
                    ))}
                  </div>
                </div>
              )}

              {invoice.activities && invoice.activities.length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-4">
                    üìÖ Activities ({invoice.activities.length})
                  </h2>
                  <div className="space-y-4">
                    {invoice.activities.map((activity) => (
                      <div
                        key={activity.id}
                        className="border-l-4 border-blue-500 pl-4 py-2"
                      >
                        <h3 className="font-semibold text-gray-900">
                          {activity.summary || "Activity"}
                        </h3>
                        <p className="text-sm text-gray-600">
                          Due: {activity.date_deadline} ‚Ä¢ State:{" "}
                          {activity.state}
                        </p>
                        {activity.note && (
                          <p className="text-sm text-gray-700 mt-1">
                            {activity.note}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {invoice.messages && invoice.messages.length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h2 className="text-2xl font-bold text-gray-900 mb-4">
                    üí¨ Messages ({invoice.messages.length})
                  </h2>
                  <div className="space-y-4">
                    {invoice.messages.map((message) => (
                      <div
                        key={message.id}
                        className="border-b border-gray-200 pb-4 last:border-0"
                      >
                        <div className="flex items-start justify-between mb-2">
                          <p className="font-semibold text-gray-900">
                            {Array.isArray(message.author_id)
                              ? message.author_id[1]
                              : "System"}
                          </p>
                          <p className="text-sm text-gray-500">
                            {new Date(message.date).toLocaleString()}
                          </p>
                        </div>
                        <div
                          className="text-gray-700 text-sm"
                          dangerouslySetInnerHTML={{ __html: message.body }}
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Monerium Payment View - Simplified (No SDK)
      function MoneriumView({ navigate }) {
        const [formData, setFormData] = useState({
          amount: "",
          iban: "",
          memo: "",
          environment: "sandbox",
          recipientType: "company",
          accountAddress: "",
          companyName: "",
          firstName: "",
          lastName: "",
        });
        const [accessToken, setAccessToken] = useState("");
        const [connected, setConnected] = useState(false);
        const [submitting, setSubmitting] = useState(false);
        const [loading, setLoading] = useState(false);
        const [success, setSuccess] = useState(null);
        const [error, setError] = useState(null);
        const [accountAddress, setAccountAddress] = useState("");
        const currentEnvironment = formData.environment;

        // Helper functions for OAuth PKCE flow
        const generateRandomString = (length) => {
          const charset =
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
          let result = "";
          const randomValues = new Uint8Array(length);
          crypto.getRandomValues(randomValues);
          for (let i = 0; i < length; i++) {
            result += charset[randomValues[i] % charset.length];
          }
          return result;
        };

        const sha256 = async (plain) => {
          const encoder = new TextEncoder();
          const data = encoder.encode(plain);
          const hash = await crypto.subtle.digest("SHA-256", data);
          return hash;
        };

        const base64urlencode = (buffer) => {
          const bytes = new Uint8Array(buffer);
          let str = "";
          for (let i = 0; i < bytes.byteLength; i++) {
            str += String.fromCharCode(bytes[i]);
          }
          return btoa(str)
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");
        };

        const generatePKCE = async () => {
          const codeVerifier = generateRandomString(128);
          const hashed = await sha256(codeVerifier);
          const codeChallenge = base64urlencode(hashed);
          return { codeVerifier, codeChallenge };
        };

        // Load access token from localStorage on mount and check for OAuth callback
        useEffect(() => {
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get("code");
          const errorParam = urlParams.get("error");
          const errorDescription = urlParams.get("error_description");
          const storedData = localStorage.getItem("monerium_oauth");

          // Check for OAuth error
          if (errorParam) {
            const errorMsg = errorDescription
              ? decodeURIComponent(errorDescription.replace(/\+/g, " "))
              : errorParam;
            setError(`OAuth Error: ${errorMsg}`);
            console.error("‚ùå OAuth Error:", errorParam, errorDescription);
            window.history.replaceState({}, document.title, "/monerium");
            localStorage.removeItem("monerium_oauth");
            return;
          }

          // Handle OAuth callback
          if (code && storedData) {
            const { codeVerifier, clientId, environment, accountAddress } =
              JSON.parse(storedData);
            exchangeCodeForToken(
              code,
              codeVerifier,
              clientId,
              environment,
              accountAddress
            );
            window.history.replaceState({}, document.title, "/monerium");
            return;
          }

          // Try to load existing connection
          const stored = localStorage.getItem("monerium_connection");
          if (stored) {
            try {
              const data = JSON.parse(stored);
              if (data.accessToken) {
                setAccessToken(data.accessToken);
                setConnected(true);
                setFormData((prev) => ({
                  ...prev,
                  environment: data.environment || "sandbox",
                }));
              }
              if (data.accountAddress) {
                setAccountAddress(data.accountAddress);
              }
            } catch (err) {
              console.error("Failed to load token:", err);
            }
          }
        }, []);

        const exchangeCodeForToken = async (
          code,
          codeVerifier,
          clientId,
          environment,
          storedAccountAddress
        ) => {
          try {
            setLoading(true);
            setError(null);

            console.log("üîÑ Sending token exchange request to backend...");

            const tokenResponse = await fetch("/api/monerium/token", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                code,
                codeVerifier,
                clientId,
                environment,
              }),
            });

            if (!tokenResponse.ok) {
              const errorData = await tokenResponse.json();
              throw new Error(
                errorData.error_description ||
                  errorData.error ||
                  "Failed to get access token"
              );
            }

            const tokenData = await tokenResponse.json();
            const token = tokenData.access_token;

            const finalAccountAddress =
              storedAccountAddress || accountAddress || "";

            // Save to localStorage
            localStorage.setItem(
              "monerium_connection",
              JSON.stringify({
                accessToken: token,
                environment,
                accountAddress: finalAccountAddress,
              })
            );
            localStorage.removeItem("monerium_oauth");

            setAccessToken(token);
            setConnected(true);
            setFormData((prev) => ({ ...prev, environment }));
            if (finalAccountAddress) {
              setAccountAddress(finalAccountAddress);
            }
            setSuccess("Connected to Monerium successfully!");
          } catch (err) {
            console.error("Token exchange failed:", err);
            setError(err.message || "Failed to complete authorization");
            localStorage.removeItem("monerium_oauth");
          } finally {
            setLoading(false);
          }
        };

        const handleConnect = async (clientId, environment, accountAddr) => {
          if (!clientId.trim()) {
            setError("Please enter a client ID");
            return;
          }

          if (!accountAddr || !accountAddr.trim()) {
            setError("Please provide the Safe or account address to use");
            return;
          }

          try {
            setLoading(true);
            setError(null);

            setAccountAddress(accountAddr.trim());

            const { codeVerifier, codeChallenge } = await generatePKCE();

            localStorage.setItem(
              "monerium_oauth",
              JSON.stringify({
                codeVerifier,
                clientId,
                environment,
                accountAddress: accountAddr.trim(),
              })
            );

            const baseUrl =
              environment === "sandbox"
                ? "https://api.monerium.dev"
                : "https://api.monerium.app";
            const authUrl = new URL(`${baseUrl}/auth`);
            authUrl.searchParams.set("client_id", clientId);
            authUrl.searchParams.set(
              "redirect_uri",
              window.location.origin + "/monerium"
            );
            authUrl.searchParams.set("code_challenge", codeChallenge);
            authUrl.searchParams.set("code_challenge_method", "S256");
            authUrl.searchParams.set("response_type", "code");

            console.log("üöÄ Redirecting to Monerium Auth");
            window.location.href = authUrl.toString();
          } catch (err) {
            console.error("Authorization failed:", err);
            setError(err.message || "Failed to start authorization");
            setLoading(false);
          }
        };

        const handleDisconnect = () => {
          localStorage.removeItem("monerium_connection");
          localStorage.removeItem("monerium_oauth");
          setAccessToken("");
          setAccountAddress("");
          setConnected(false);
          setSuccess(null);
          setError(null);
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setSubmitting(true);
          setError(null);
          setSuccess(null);

          try {
            console.log("üí∏ Initiating Payment:", formData);

            if (!accessToken) {
              throw new Error("Please set your access token first");
            }

            if (!accountAddress) {
              throw new Error(
                "Please provide the account address in the connection settings"
              );
            }

            if (formData.recipientType === "company") {
              if (!formData.companyName.trim()) {
                throw new Error("Company name is required");
              }
            } else {
              if (!formData.firstName.trim() || !formData.lastName.trim()) {
                throw new Error("Recipient first and last name are required");
              }
            }

            const payload = {
              amount: formData.amount,
              iban: formData.iban,
              memo: formData.memo,
              companyName: formData.companyName,
              environment: formData.environment,
              accessToken: accessToken,
              accountAddress: accountAddress,
            };

            console.log(">>> Placing order", payload);
            // Call backend API to place order
            const response = await fetch("/api/monerium/order", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const errorData = await response.json();
              let msg =
                errorData.error || errorData.message || "Failed to place order";
              if (errorData.errors && errorData.errors.amount) {
                msg = `${errorData.errors?.amount} (balance: ‚Ç¨${errorData.errors?.balance})`;
              }
              throw new Error(msg);
            }

            const order = await response.json();
            console.log("‚úÖ Payment Order Placed:", order);

            setSuccess(
              `Payment order placed successfully! Order ID: ${
                order.id || "unknown"
              }`
            );

            // Reset form (keep environment)
            setFormData((prev) => ({
              amount: "",
              iban: "",
              memo: "",
              environment: prev.environment,
              recipientType: prev.recipientType,
              companyName: "",
              firstName: "",
              lastName: "",
            }));
          } catch (err) {
            console.error("‚ùå Payment failed:", err.message);
            setError(err.message || "Failed to initiate payment");
          } finally {
            setSubmitting(false);
          }
        };

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData((prev) => {
            if (name === "recipientType") {
              return {
                ...prev,
                recipientType: value,
                companyName: value === "company" ? prev.companyName : "",
                firstName: value === "individual" ? prev.firstName : "",
                lastName: value === "individual" ? prev.lastName : "",
              };
            }
            return { ...prev, [name]: value };
          });
        };

        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-3xl mx-auto px-4 py-8">
              <div className="mb-8 flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <button
                    onClick={() => navigate("/")}
                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    ‚Üê Back
                  </button>
                  <h1 className="text-4xl font-bold text-gray-900">
                    üí≥ Monerium Payment
                  </h1>
                </div>
                {connected && (
                  <button
                    onClick={handleDisconnect}
                    className="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors"
                  >
                    Disconnect
                  </button>
                )}
              </div>

              {error && (
                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-red-800">{error}</p>
                </div>
              )}

              {success && (
                <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                  <p className="text-green-800">{success}</p>
                </div>
              )}

              {loading && (
                <div className="flex items-center justify-center py-12">
                  <LoaderIcon />
                </div>
              )}

              {!connected && !loading && (
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h2 className="text-2xl font-bold text-gray-900 mb-6">
                    üîê Connect to Monerium
                  </h2>
                  <p className="text-sm text-gray-600 mb-6">
                    Enter your Monerium Client ID to connect your account. You
                    can get a Client ID by creating an app at{" "}
                    <a
                      href="https://sandbox.monerium.dev/developers"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-blue-600 hover:underline"
                    >
                      sandbox.monerium.dev/developers
                    </a>
                    .
                  </p>
                  <form
                    onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      const environment = (
                        formData.get("environment") || "sandbox"
                      ).toString();
                      const accountAddr = (
                        formData.get("accountAddress") || ""
                      ).toString();
                      const clientId = (
                        formData.get("clientId") || ""
                      ).toString();
                      handleConnect(clientId, environment, accountAddr);
                    }}
                    className="space-y-6"
                  >
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Environment
                      </label>
                      <select
                        name="environment"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="sandbox">Sandbox</option>
                        <option value="production">Production</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Client ID
                      </label>
                      <input
                        type="text"
                        name="clientId"
                        placeholder="Your Monerium Client ID"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Account Address (Safe or EOA)
                      </label>
                      <input
                        type="text"
                        name="accountAddress"
                        placeholder="0x..."
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                        required
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        This address will be used as the payer account for
                        Monerium payments.
                      </p>
                    </div>
                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold rounded-lg transition-colors"
                    >
                      {loading ? "Connecting..." : "Connect with Monerium"}
                    </button>
                  </form>
                  <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p className="text-sm text-blue-800">
                      <strong>Note:</strong> You'll be redirected to Monerium to
                      authorize this application. Make sure your redirect URI is
                      set to:{" "}
                      <code className="bg-white px-2 py-1 rounded">
                        {window.location.origin}/monerium
                      </code>
                    </p>
                  </div>
                </div>
              )}

              {connected && !loading && (
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h2 className="text-2xl font-bold text-gray-900 mb-6">
                    üí∏ Initiate Payment Order
                  </h2>

                  <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                      <span className="block text-sm font-medium text-gray-700 mb-2">
                        Recipient Type
                      </span>
                      <div className="flex items-center space-x-4">
                        <label className="inline-flex items-center space-x-2">
                          <input
                            type="radio"
                            name="recipientType"
                            value="company"
                            checked={formData.recipientType === "company"}
                            onChange={handleChange}
                          />
                          <span>Company</span>
                        </label>
                        <label className="inline-flex items-center space-x-2">
                          <input
                            type="radio"
                            name="recipientType"
                            value="individual"
                            checked={formData.recipientType === "individual"}
                            onChange={handleChange}
                          />
                          <span>Individual</span>
                        </label>
                      </div>
                    </div>

                    {formData.recipientType === "company" ? (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Company Name
                        </label>
                        <input
                          type="text"
                          name="companyName"
                          value={formData.companyName}
                          onChange={handleChange}
                          placeholder="Recipient company name"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          required
                        />
                      </div>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            First Name
                          </label>
                          <input
                            type="text"
                            name="firstName"
                            value={formData.firstName}
                            onChange={handleChange}
                            placeholder="Recipient first name"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Last Name
                          </label>
                          <input
                            type="text"
                            name="lastName"
                            value={formData.lastName}
                            onChange={handleChange}
                            placeholder="Recipient last name"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                          />
                        </div>
                      </div>
                    )}

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Amount
                      </label>
                      <input
                        type="number"
                        name="amount"
                        value={formData.amount}
                        onChange={handleChange}
                        step="0.01"
                        min="0.01"
                        placeholder="0.00"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Counterpart IBAN
                      </label>
                      <input
                        type="text"
                        name="iban"
                        value={formData.iban}
                        onChange={handleChange}
                        placeholder="DE89370400440532013000"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Memo / Reference (optional)
                      </label>
                      <input
                        type="text"
                        name="memo"
                        value={formData.memo}
                        onChange={handleChange}
                        placeholder="Payment reference or description"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        maxLength="140"
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        {formData.memo.length}/140 characters
                      </p>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Account Address
                      </label>
                      <input
                        type="text"
                        value={accountAddress}
                        onChange={(e) => setAccountAddress(e.target.value)}
                        placeholder="0x..."
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                        required
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        This address will be used for Monerium payments. Add
                        your Safe address here if you want to pay from a Safe.
                      </p>
                    </div>

                    <button
                      type="submit"
                      disabled={submitting}
                      className="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold rounded-lg transition-colors"
                    >
                      {submitting ? "Processing..." : "Place Order"}
                    </button>
                  </form>

                  <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p className="text-sm text-blue-800">
                      <strong>Note:</strong> Orders are signed on the server
                      using the PRIVATE_KEY environment variable. The Ethereum
                      address is derived from the private key, and the order is
                      signed with viem before being sent to Monerium's API.
                    </p>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Monthly Invoices View Component
      function MonthlyInvoicesView({
        year,
        month,
        connectionSettings,
        sessionId,
        navigate,
      }) {
        const [invoices, setInvoices] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedInvoice, setSelectedInvoice] = useState(null);

        useEffect(() => {
          const fetchMonthlyInvoices = async () => {
            setLoading(true);
            setError(null);

            const monthNum = parseInt(month);
            const yearNum = parseInt(year);
            const firstDay = `${yearNum}-${monthNum
              .toString()
              .padStart(2, "0")}-01`;

            const lastDay = new Date(yearNum, monthNum, 0).getDate();
            const lastDayStr = `${yearNum}-${monthNum
              .toString()
              .padStart(2, "0")}-${lastDay}`;

            const params = new URLSearchParams();
            Object.entries(connectionSettings).forEach(([key, value]) => {
              if (value) params.append(key, value);
            });
            params.append("since", firstDay);
            params.append("until", lastDayStr);
            params.append("limit", "1000");

            try {
              const response = await fetch(
                `/api/odoo/invoices?${params.toString()}`
              );
              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.error || "Failed to fetch invoices");
              }

              setInvoices(data.invoices);
            } catch (err) {
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };

          fetchMonthlyInvoices();
        }, [year, month, connectionSettings]);

        const monthName = new Date(
          parseInt(year),
          parseInt(month) - 1,
          1
        ).toLocaleString("default", { month: "long" });

        if (loading) {
          return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
              <LoaderIcon />
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-7xl mx-auto px-4 py-8">
              <button
                onClick={() => navigate("/")}
                className="mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
              >
                ‚Üê Back to Invoices
              </button>

              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                üìÖ {monthName} {year}
              </h1>
              <p className="text-gray-600 mb-8">
                {invoices.length} invoice{invoices.length !== 1 ? "s" : ""}{" "}
                found
              </p>

              {error && (
                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-red-800">{error}</p>
                </div>
              )}

              {invoices.length > 0 && (
                <div className="space-y-4">
                  {invoices.map((invoice) => (
                    <InvoiceCard
                      key={invoice.id}
                      invoice={invoice}
                      onPreview={setSelectedInvoice}
                      odooUrl={connectionSettings.url}
                      onPay={handlePay}
                    />
                  ))}
                </div>
              )}

              {invoices.length === 0 && !error && (
                <div className="text-center py-12 text-gray-500">
                  No invoices found for {monthName} {year}.
                </div>
              )}
            </div>

            {selectedInvoice && (
              <PDFSidebar
                invoice={selectedInvoice}
                onClose={() => setSelectedInvoice(null)}
                odooUrl={connectionSettings.url}
                sessionId={sessionId}
              />
            )}
          </div>
        );
      }

      function App() {
        const [invoices, setInvoices] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [selectedInvoice, setSelectedInvoice] = useState(null);
        const [showConnectionSettings, setShowConnectionSettings] =
          useState(false);

        // Load connection settings from localStorage
        const loadConnectionSettings = () => {
          try {
            const stored = localStorage.getItem("odoo_connection");
            if (stored) {
              return JSON.parse(stored);
            }
          } catch (err) {
            console.error("Failed to load connection settings:", err);
          }
          return { url: "", db: "", username: "", password: "" };
        };

        const [connectionSettings, setConnectionSettings] = useState(
          loadConnectionSettings
        );
        const [filters, setFilters] = useState({
          type: "all",
          limit: "20",
          since: "",
          until: "",
        });
        const [sessionId, setSessionId] = useState(null);

        // Authenticate with Odoo to get session_id
        const authenticateOdoo = async () => {
          if (!isConnectionConfigured()) return null;

          try {
            const params = new URLSearchParams({
              url: connectionSettings.url,
              db: connectionSettings.db,
              username: connectionSettings.username,
              password: connectionSettings.password,
            });

            const response = await fetch(
              `/api/odoo/authenticate?${params.toString()}`
            );
            const data = await response.json();

            if (!response.ok) {
              console.error("Authentication failed:", data.error);
              return null;
            }

            setSessionId(data.session_id);
            return data.session_id;
          } catch (err) {
            console.error("Authentication error:", err);
            return null;
          }
        };

        // Authenticate when opening invoice for PDF preview
        useEffect(() => {
          if (selectedInvoice && !sessionId) {
            authenticateOdoo();
          }
        }, [selectedInvoice]);

        // Check if connection settings are configured
        const isConnectionConfigured = () => {
          return (
            connectionSettings.url &&
            connectionSettings.db &&
            connectionSettings.username &&
            connectionSettings.password
          );
        };

        // Show connection panel if not configured
        useEffect(() => {
          if (!isConnectionConfigured()) {
            setShowConnectionSettings(true);
          }
        }, []);

        const fetchInvoices = async () => {
          setLoading(true);
          setError(null);

          const params = new URLSearchParams();

          // Add connection settings
          Object.entries(connectionSettings).forEach(([key, value]) => {
            if (value) params.append(key, value);
          });

          // Add filters
          Object.entries(filters).forEach(([key, value]) => {
            if (value) params.append(key, value);
          });

          try {
            const response = await fetch(
              `/api/odoo/invoices?${params.toString()}`
            );
            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || "Failed to fetch invoices");
            }

            setInvoices(data.invoices);
          } catch (err) {
            console.error(err);
            let msg = err.message;
            if (err.errors.amount) {
              msg = `${err.errors.amount} (balance: ‚Ç¨${err.errors.balance})`;
            }
            setError(msg);
          } finally {
            setLoading(false);
          }
        };

        const handleFilterChange = (e) => {
          setFilters({ ...filters, [e.target.name]: e.target.value });
        };

        const handleConnectionChange = (e) => {
          setConnectionSettings({
            ...connectionSettings,
            [e.target.name]: e.target.value,
          });
        };

        const saveConnectionSettings = () => {
          try {
            localStorage.setItem(
              "odoo_connection",
              JSON.stringify(connectionSettings)
            );
            setShowConnectionSettings(false);
            setError(null);
          } catch (err) {
            setError("Failed to save connection settings");
          }
        };

        const clearConnectionSettings = () => {
          try {
            localStorage.removeItem("odoo_connection");
            setConnectionSettings({
              url: "",
              db: "",
              username: "",
              password: "",
            });
            setShowConnectionSettings(true);
          } catch (err) {
            setError("Failed to clear connection settings");
          }
        };

        useEffect(() => {
          if (isConnectionConfigured()) {
            fetchInvoices();
          }
        }, [connectionSettings]);

        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-7xl mx-auto px-4 py-8">
              <div className="mb-8 flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <h1 className="text-4xl font-bold text-gray-900">
                    üìã Odoo Invoices
                  </h1>
                  <button
                    onClick={() =>
                      window.history.pushState({}, "", "/monerium") ||
                      window.dispatchEvent(new PopStateEvent("popstate"))
                    }
                    className="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg transition-colors text-sm font-medium"
                  >
                    üí≥ Monerium
                  </button>
                </div>
                {isConnectionConfigured() && (
                  <div className="flex items-center space-x-3">
                    <div className="flex items-center space-x-2 px-4 py-2 bg-green-50 border border-green-200 rounded-lg">
                      <svg
                        className="w-5 h-5 text-green-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fillRule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                          clipRule="evenodd"
                        />
                      </svg>
                      <span className="text-sm font-medium text-green-800">
                        Connected to {connectionSettings.db}
                      </span>
                    </div>
                    <button
                      onClick={() =>
                        setShowConnectionSettings(!showConnectionSettings)
                      }
                      className="flex items-center space-x-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors"
                    >
                      <SettingsIcon />
                      <span>
                        {showConnectionSettings ? "Hide" : "Edit"} Settings
                      </span>
                    </button>
                    <button
                      onClick={clearConnectionSettings}
                      className="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors"
                    >
                      Disconnect
                    </button>
                  </div>
                )}
              </div>

              {error && (
                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-red-800">{error}</p>
                </div>
              )}

              {(!isConnectionConfigured() || showConnectionSettings) && (
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-lg font-semibold mb-4">
                    üîê Odoo Connection Settings
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input
                      type="text"
                      name="url"
                      placeholder="Odoo URL (e.g., https://yourcompany.odoo.com)"
                      value={connectionSettings.url}
                      onChange={handleConnectionChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <input
                      type="text"
                      name="db"
                      placeholder="Database name"
                      value={connectionSettings.db}
                      onChange={handleConnectionChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <input
                      type="text"
                      name="username"
                      placeholder="Username"
                      value={connectionSettings.username}
                      onChange={handleConnectionChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <input
                      type="password"
                      name="password"
                      placeholder="Password"
                      value={connectionSettings.password}
                      onChange={handleConnectionChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <button
                    onClick={saveConnectionSettings}
                    className="w-full md:w-auto px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors"
                  >
                    Save Connection
                  </button>
                </div>
              )}

              {isConnectionConfigured() && (
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-lg font-semibold mb-4">üîç Filters</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <select
                      name="type"
                      value={filters.type}
                      onChange={handleFilterChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="all">All Invoices</option>
                      <option value="incoming">Incoming (Supplier)</option>
                      <option value="outgoing">Outgoing (Customer)</option>
                    </select>
                    <input
                      type="number"
                      name="limit"
                      placeholder="Limit"
                      value={filters.limit}
                      onChange={handleFilterChange}
                      min="1"
                      max="100"
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <input
                      type="date"
                      name="since"
                      placeholder="Since date"
                      value={filters.since}
                      onChange={handleFilterChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <input
                      type="date"
                      name="until"
                      placeholder="Until date"
                      value={filters.until}
                      onChange={handleFilterChange}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <button
                    onClick={fetchInvoices}
                    disabled={loading}
                    className="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold rounded-lg transition-colors"
                  >
                    {loading ? "Loading..." : "Fetch Invoices"}
                  </button>
                </div>
              )}

              {loading && (
                <div className="flex justify-center items-center py-12">
                  <LoaderIcon />
                </div>
              )}

              {!loading && invoices.length > 0 && (
                <div className="space-y-4">
                  {invoices.map((invoice) => (
                    <InvoiceCard
                      key={invoice.id}
                      invoice={invoice}
                      onPreview={setSelectedInvoice}
                      odooUrl={connectionSettings.url}
                      onPay={handlePay}
                    />
                  ))}
                </div>
              )}

              {!loading && invoices.length === 0 && (
                <div className="text-center py-12 text-gray-500">
                  {isConnectionConfigured()
                    ? 'No invoices found. Try adjusting your filters or click "Fetch Invoices".'
                    : "Please configure your Odoo connection to get started."}
                </div>
              )}
            </div>

            {selectedInvoice && (
              <PDFSidebar
                invoice={selectedInvoice}
                onClose={() => setSelectedInvoice(null)}
                odooUrl={connectionSettings.url}
                sessionId={sessionId}
              />
            )}
          </div>
        );
      }

      function RootApp() {
        // Load connection settings from localStorage
        const loadConnectionSettings = () => {
          try {
            const stored = localStorage.getItem("odoo_connection");
            if (stored) {
              return JSON.parse(stored);
            }
          } catch (err) {
            console.error("Failed to load connection settings:", err);
          }
          return { url: "", db: "", username: "", password: "" };
        };

        const [connectionSettings] = useState(loadConnectionSettings);
        const [sessionId] = useState(null);

        return (
          <Router>
            {({ currentPath, navigate }) => {
              // Match /monerium route
              if (currentPath === "/monerium") {
                return <MoneriumView navigate={navigate} />;
              }

              // Match /invoices/:id pattern
              const invoiceDetailsMatch =
                currentPath.match(/^\/invoices\/(\d+)$/);
              if (invoiceDetailsMatch) {
                const invoiceId = invoiceDetailsMatch[1];
                return (
                  <InvoiceDetailsView
                    invoiceId={invoiceId}
                    connectionSettings={connectionSettings}
                    sessionId={sessionId}
                    navigate={navigate}
                  />
                );
              }

              // Match /:year/:month pattern
              const monthlyMatch = currentPath.match(/^\/(\d{4})\/(\d{1,2})$/);
              if (monthlyMatch) {
                const [, year, month] = monthlyMatch;
                return (
                  <MonthlyInvoicesView
                    year={year}
                    month={month}
                    connectionSettings={connectionSettings}
                    sessionId={sessionId}
                    navigate={navigate}
                  />
                );
              }

              // Default: show main app
              return <App />;
            }}
          </Router>
        );
      }

      ReactDOM.render(<RootApp />, document.getElementById("root"));
    </script>
  </body>
</html>
